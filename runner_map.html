<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
    />
    <title>R2U Kakao Map - Stable Version</title>
    <style>
        html, body { margin:0; padding:0; height:100%; }
        #map { width:100%; height:90vh; }
        #info { padding:10px; font-family: Arial, sans-serif; font-size: 14px; }
        
        /* ğŸš¨ JSON ë””ë²„ê·¸ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        #json_container {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ccc;
            padding: 10px;
            max-width: 400px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        #json_output {
            width: 100%;
            height: 200px;
            resize: none;
            font-size: 10px;
            margin-top: 5px;
        }
        #toggle_json {
            cursor: pointer;
            color: blue;
            text-decoration: underline;
        }
    </style>
    
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f3beaea643bdd2136019b366df1190cf&libraries=services,clusterer,drawing"></script>
</head>
<body>

<div id="info">
    <h2>ëŸ¬ë‹ ê²½ë¡œ ì‹œê°í™”</h2>
    <p>API Endpoint: <code>http://116.193.90.76:8000/api/recommend-route</code></p>
    <p id="current_params">íŒŒë¼ë¯¸í„°: ë¡œë”© ì¤‘...</p>
    <p id="status_display">ìƒíƒœ: ì§€ë„ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ëŒ€ê¸° ì¤‘... (<span id="toggle_json">JSON ì „ë¬¸ ë³´ê¸°/ìˆ¨ê¸°ê¸°</span>)</p>
</div>

<div id="map"></div>

<div id="json_container" style="display:none;">
    <h4>API ì‘ë‹µ ì „ë¬¸ (JSON)</h4>
    <textarea id="json_output" readonly></textarea>
    <button onclick="copyJson()">JSON ë³µì‚¬</button>
</div>


<script>
    // --- ì„¤ì • ---
    const API_HOST = "http://116.193.90.76:8000";
    const API_PATH = "/api/recommend-route";
    // -----------------

    var map;
    var routeLine = null;
    var startMarker = null;
    var endMarker = null;
    var turnMarkers = [];   // ğŸ¯ ì¶”ê°€: turns ë§ˆì»¤ ì €ì¥ ë°°ì—´

    const urlParams = new URLSearchParams(window.location.search);
    const CURRENT_LAT = parseFloat(urlParams.get('lat'));
    const CURRENT_LNG = parseFloat(urlParams.get('lng'));
    const CURRENT_KM = parseFloat(urlParams.get('km'));
    const params = { lat: CURRENT_LAT, lng: CURRENT_LNG, km: CURRENT_KM };

    const statusDisplay = document.getElementById('status_display');
    const currentParamsDisplay = document.getElementById('current_params');
    const jsonContainer = document.getElementById('json_container');
    const jsonOutput = document.getElementById('json_output');
    
    document.getElementById('toggle_json').onclick = function() {
        jsonContainer.style.display = jsonContainer.style.display === 'none' ? 'block' : 'none';
    };

    function copyJson() {
        jsonOutput.select();
        navigator.clipboard.writeText(jsonOutput.value)
            .then(() => alert("JSON ì „ë¬¸ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."))
            .catch(err => alert("ë³µì‚¬ ì‹¤íŒ¨: " + err));
    }

    window.onload = function() {
        if (isNaN(CURRENT_LAT) || isNaN(CURRENT_LNG) || isNaN(CURRENT_KM)) {
            currentParamsDisplay.innerHTML = 'íŒŒë¼ë¯¸í„°: ìœ íš¨í•˜ì§€ ì•ŠìŒ';
            statusDisplay.innerHTML = 'âŒ URL íŒŒë¼ë¯¸í„° ì˜¤ë¥˜';
            return;
        }

        currentParamsDisplay.innerHTML =
            `íŒŒë¼ë¯¸í„°: Lat: ${CURRENT_LAT}, Lng: ${CURRENT_LNG}, KM: ${CURRENT_KM}`;
        
        const container = document.getElementById('map');
        const centerCoords = new kakao.maps.LatLng(CURRENT_LAT, CURRENT_LNG);
        const options = { center: centerCoords, level: 3 };

        if (typeof kakao === 'undefined' || typeof kakao.maps === 'undefined') {
             statusDisplay.innerHTML = 'âŒ ì¹´ì¹´ì˜¤ ì§€ë„ SDK ë¡œë“œ ì‹¤íŒ¨';
             return;
        }

        map = new kakao.maps.Map(container, options);

        new kakao.maps.Marker({
            map: map,
            position: centerCoords,
            title: 'ì¶œë°œ/ë„ì°© ì§€ì '
        });

        fetchRoute();
    };

    function fetchRoute() {
        const query = new URLSearchParams(params).toString();
        const fullUrl = `${API_HOST}${API_PATH}?${query}`;
        
        statusDisplay.innerHTML = 'ìƒíƒœ: ê²½ë¡œ ìš”ì²­ ì¤‘...';

        fetch(fullUrl)
            .then(res => res.json())
            .then(data => {
                jsonOutput.value = JSON.stringify(data, null, 2);

                if (data.status === 'ok') {
                    showRecommendedRoute(data);
                    statusDisplay.innerHTML =
                        `ìƒíƒœ: âœ… ë¡œë“œ ì„±ê³µ. (ê±°ë¦¬ ${data.summary.length_m}m)`;
                } else {
                    statusDisplay.innerHTML = `âŒ ê²½ë¡œ ìƒì„± ì‹¤íŒ¨`;
                }
            })
            .catch(error => {
                statusDisplay.innerHTML = `ğŸš¨ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
            });
    }

    // ğŸ¯ (A) turns ë°°ì—´ì„ ì§€ë„ì— ë§ˆì»¤ + hover ì •ë³´ì°½ìœ¼ë¡œ í‘œì‹œ
    function drawTurnMarkers(turns) {
        // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
        turnMarkers.forEach(m => m.setMap(null));
        turnMarkers = [];

        turns.forEach(turn => {
            const pos = new kakao.maps.LatLng(turn.lat, turn.lng);

            const marker = new kakao.maps.Marker({
                map: map,
                position: pos,
                image: new kakao.maps.MarkerImage(
                    "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png",
                    new kakao.maps.Size(40, 40)
                )
            });

            // hoverìš© InfoWindow
            const info = new kakao.maps.InfoWindow({
                content: `
                    <div style="
                        padding:6px 10px;
                        background:white;
                        border:1px solid #444;
                        border-radius:5px;
                        font-size:13px;
                    ">
                        ${turn.instruction}
                    </div>
                `
            });

            kakao.maps.event.addListener(marker, "mouseover", () => {
                info.open(map, marker);
            });

            kakao.maps.event.addListener(marker, "mouseout", () => {
                info.close();
            });

            turnMarkers.push(marker);
        });
    }

    // ğŸ¯ (B) ì „ì²´ ê²½ë¡œ + turns ë§ˆì»¤ í‘œì‹œ
    function showRecommendedRoute(routeData) {

        var linePath = routeData.polyline.map(p =>
            new kakao.maps.LatLng(Number(p.lat), Number(p.lng))
        );

        if (routeLine) routeLine.setMap(null);
        if (startMarker) startMarker.setMap(null);
        if (endMarker) endMarker.setMap(null);

        routeLine = new kakao.maps.Polyline({
            map: map,
            path: linePath,
            strokeWeight: 5,
            strokeColor: '#00C853',
            strokeOpacity: 0.9
        });

        startMarker = new kakao.maps.Marker({ map, position: linePath[0] });
        endMarker = new kakao.maps.Marker({ map, position: linePath[linePath.length-1] });

        var bounds = new kakao.maps.LatLngBounds();
        linePath.forEach(pos => bounds.extend(pos));
        map.setBounds(bounds);

        // ğŸ¯ Turn ì§€ì  ë§ˆì»¤ í‘œì‹œ
        if (routeData.turns && routeData.turns.length > 0) {
            drawTurnMarkers(routeData.turns);
        }
    }

</script>
</body>
</html>

