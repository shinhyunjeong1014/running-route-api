<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
    />
    <title>R2U Kakao Map - Stable Version</title>
    <style>
        html, body { margin:0; padding:0; height:100%; }
        #map { width:100%; height:90vh; }
        #info { padding:10px; font-family: Arial, sans-serif; font-size: 14px; }
        
        /* ğŸš¨ JSON ë””ë²„ê·¸ ì˜ì—­ ìŠ¤íƒ€ì¼ (ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€) */
        #json_container {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ccc;
            padding: 10px;
            max-width: 400px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        #json_output {
            width: 100%;
            height: 200px;
            resize: none;
            font-size: 10px;
            margin-top: 5px;
        }
        #toggle_json {
            cursor: pointer;
            color: blue;
            text-decoration: underline;
        }
    </style>
    
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f3beaea643bdd2136019b366df1190cf&libraries=services,clusterer,drawing"></script>
</head>
<body>

<div id="info">
    <h2>ëŸ¬ë‹ ê²½ë¡œ ì‹œê°í™”</h2>
    <p>API Endpoint: <code>http://116.193.90.76:8000/api/recommend-route</code></p>
    <p id="current_params">íŒŒë¼ë¯¸í„°: ë¡œë”© ì¤‘...</p>
    <p id="status_display">ìƒíƒœ: ì§€ë„ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ëŒ€ê¸° ì¤‘... (<span id="toggle_json">JSON ì „ë¬¸ ë³´ê¸°/ìˆ¨ê¸°ê¸°</span>)</p>
</div>
<div id="map"></div>

<div id="json_container" style="display:none;">
    <h4>API ì‘ë‹µ ì „ë¬¸ (JSON)</h4>
    <textarea id="json_output" readonly></textarea>
    <button onclick="copyJson()">JSON ë³µì‚¬</button>
</div>


<script>
    // --- ì„¤ì • ---
    const API_HOST = "http://116.193.90.76:8000";
    const API_PATH = "/api/recommend-route";
    // -----------------

    // ì „ì—­ ë³€ìˆ˜ (ì§€ë„/ê²½ë¡œ ê´€ë¦¬ìš©)
    var map;
    var routeLine = null;
    var startMarker = null;
    var endMarker = null;
    
    // 1. URL íŒŒë¼ë¯¸í„°ë¥¼ ì½ê³  ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥
    const urlParams = new URLSearchParams(window.location.search);
    const CURRENT_LAT = parseFloat(urlParams.get('lat'));
    const CURRENT_LNG = parseFloat(urlParams.get('lng'));
    const CURRENT_KM = parseFloat(urlParams.get('km'));
    const params = { lat: CURRENT_LAT, lng: CURRENT_LNG, km: CURRENT_KM };

    // DOM ìš”ì†Œ ìºì‹œ
    const statusDisplay = document.getElementById('status_display');
    const currentParamsDisplay = document.getElementById('current_params');
    const jsonContainer = document.getElementById('json_container');
    const jsonOutput = document.getElementById('json_output');
    
    // 2. JSON í‘œì‹œ í† ê¸€ ê¸°ëŠ¥
    document.getElementById('toggle_json').onclick = function() {
        jsonContainer.style.display = jsonContainer.style.display === 'none' ? 'block' : 'none';
    };

    // 3. JSON ë³µì‚¬ ê¸°ëŠ¥
    function copyJson() {
        jsonOutput.select();
        document.execCommand('copy');
        alert("JSON ì „ë¬¸ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    // 4. [í•µì‹¬] ëª¨ë“  ì§€ë„ ë° ê²½ë¡œ ë¡œì§ì„ window.onload ì´ë²¤íŠ¸ì—ì„œ ì•ˆì „í•˜ê²Œ ì‹¤í–‰
    window.onload = function() {
        
        // íŒŒë¼ë¯¸í„° ìœ íš¨ì„± ê²€ì‚¬
        if (isNaN(CURRENT_LAT) || isNaN(CURRENT_LNG) || isNaN(CURRENT_KM)) {
            currentParamsDisplay.innerHTML = 'íŒŒë¼ë¯¸í„°: ìœ íš¨í•˜ì§€ ì•ŠìŒ';
            statusDisplay.innerHTML = 'âŒ **ì˜¤ë¥˜:** URL íŒŒë¼ë¯¸í„°(lat, lng, km)ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.';
            document.getElementById('map').innerHTML = 'ìœ íš¨í•œ ê²½ë¡œ íŒŒë¼ë¯¸í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            return;
        }

        // íŒŒë¼ë¯¸í„° ì •ë³´ ì¶œë ¥
        currentParamsDisplay.innerHTML = `íŒŒë¼ë¯¸í„°: Lat: ${CURRENT_LAT}, Lng: ${CURRENT_LNG}, KM: ${CURRENT_KM}`;
        
        // 5. ì§€ë„ ê°ì²´ ìƒì„±
        const container = document.getElementById('map');
        const centerCoords = new kakao.maps.LatLng(CURRENT_LAT, CURRENT_LNG);
        const options = {
            center: centerCoords, 
            level: 3
        };
        
        // kakao.maps ê°ì²´ í™•ì¸ (SDK ë¡œë“œ ì™„ë£Œ ì²´í¬)
        if (typeof kakao === 'undefined' || typeof kakao.maps === 'undefined') {
             statusDisplay.innerHTML = 'âŒ **ì˜¤ë¥˜:** ì¹´ì¹´ì˜¤ ì§€ë„ SDK ë¡œë“œ ì‹¤íŒ¨. API í‚¤ë‚˜ ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
             return;
        }

        map = new kakao.maps.Map(container, options);
        
        // ë§ˆì»¤ ìƒì„± (ì¶œë°œì )
        new kakao.maps.Marker({
            map: map,
            position: centerCoords,
            title: 'ì¶œë°œ/ë„ì°© ì§€ì '
        });

        // 6. API í˜¸ì¶œ ì‹œì‘
        fetchRoute();
    };

    // 7. API í˜¸ì¶œ ë° ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜
    function fetchRoute() {
        const query = new URLSearchParams(params).toString();
        const fullUrl = `${API_HOST}${API_PATH}?${query}`;
        
        statusDisplay.innerHTML = 'ìƒíƒœ: ê²½ë¡œ ë°ì´í„° ìš”ì²­ ì¤‘...';

        fetch(fullUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // [âœ… ë””ë²„ê·¸ ê¸°ëŠ¥] JSON ì „ë¬¸ì„ í¬ë§·í•˜ì—¬ í…ìŠ¤íŠ¸ ì˜ì—­ì— ì¶œë ¥
                jsonOutput.value = JSON.stringify(data, null, 2); 
                
                if (data.status === 'ok') {
                    // API ì‘ë‹µ ì„±ê³µ ì‹œ, ê²½ë¡œ ì‹œê°í™” í•¨ìˆ˜ í˜¸ì¶œ
                    showRecommendedRoute(data); 
                    statusDisplay.innerHTML = `ìƒíƒœ: âœ… ê²½ë¡œ ë¡œë“œ ì„±ê³µ. (ê±°ë¦¬: ${data.summary.length_m}m, ì˜ˆìƒ ì‹œê°„: ${data.summary.estimated_time_min}ë¶„)`;
                } else {
                    statusDisplay.innerHTML = `ìƒíƒœ: âŒ ê²½ë¡œ ìƒì„± ì‹¤íŒ¨. (${data.message})`;
                    console.error('API Error:', data.message);
                }
            })
            .catch(error => {
                statusDisplay.innerHTML = `ìƒíƒœ: ğŸš¨ ê²½ë¡œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}.`;
                console.error('Fetch Error:', error);
            });
    }

    // 8. ê²½ë¡œ í‘œì‹œ ë¡œì§
    function showRecommendedRoute(routeData) {
        if (!routeData || !Array.isArray(routeData.polyline)) {
            console.warn("âš  polyline ë°°ì—´ì´ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.");
            return;
        }

        var linePath = routeData.polyline.map(function(p) {
            var lat = Number(p.lat);
            var lng = Number(p.lng);
            return new kakao.maps.LatLng(lat, lng); 
        });

        if (linePath.length === 0) {
            console.warn("âš  linePathê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
            return;
        }

        // ê¸°ì¡´ ê²½ë¡œ/ë§ˆì»¤ ì œê±°
        if (routeLine) {
            routeLine.setMap(null);
        }
        if (startMarker) startMarker.setMap(null);
        if (endMarker) endMarker.setMap(null);

        // ìƒˆ Polyline ìƒì„± (ì´ˆë¡ìƒ‰)
        routeLine = new kakao.maps.Polyline({
            map: map,
            path: linePath,
            strokeWeight: 5,
            strokeColor: '#00C853',
            strokeOpacity: 0.9,
            strokeStyle: 'solid'
        });

        // ì‹œì‘/ë ë§ˆì»¤
        var startPos = linePath[0];
        var endPos = linePath[linePath.length - 1];

        startMarker = new kakao.maps.Marker({
            map: map,
            position: startPos
        });

        endMarker = new kakao.maps.Marker({
            map: map,
            position: endPos
        });

        // í™”ë©´ì„ ì „ì²´ ê²½ë¡œì— ë§ì¶”ê¸°
        var bounds = new kakao.maps.LatLngBounds();
        linePath.forEach(function (pos) {
            bounds.extend(pos);
        });
        map.setBounds(bounds);
    }
    
    // 9. ë³µì‚¬ ë²„íŠ¼ì„ ì „ì—­ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì •ì˜
    function copyJson() {
        jsonOutput.select();
        // Modern browsers need async permission for copy command
        navigator.clipboard.writeText(jsonOutput.value).then(() => {
            alert("JSON ì „ë¬¸ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }).catch(err => {
            alert("í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + err);
        });
    }

</script>
</body>
</html>
