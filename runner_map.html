<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ëŸ¬ë‹ ê²½ë¡œ ì¶”ì²œ ì‹œê°í™”</title>
    <style>
        #map {
            width: 100%;
            height: 90vh;
        }
        #info {
            padding: 10px;
            font-family: Arial, sans-serif;
            font-size: 14px;
        }
    </style>
    
    <script type="text/javascript" 
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_APP_KEY_HERE&libraries=services,clusterer,drawing&autoload=false" 
            data-onload="initMapLogic" defer></script> 
</head>
<body>

<div id="info">
    <h2>ğŸƒâ€â™€ï¸ ëŸ¬ë‹ ê²½ë¡œ ì‹œê°í™”</h2>
    <p>API Endpoint: <code>http://116.193.90.76:8000/api/recommend-route</code></p>
    <p id="current_params">íŒŒë¼ë¯¸í„°: ë¡œë”© ì¤‘...</p>
    <p id="status_display">ìƒíƒœ: ë¡œë”© ì¤‘...</p>
</div>

<div id="map"></div>


<script>
    // --- ì„¤ì • ---
    const API_HOST = "http://116.193.90.76:8000";
    const API_PATH = "/api/recommend-route";
    // -----------------

    // [ìµœì¢… ìˆ˜ì •] ì§€ë„ SDK ë¡œë“œê°€ ì™„ë£Œë˜ë©´ ì´ í•¨ìˆ˜ê°€ Kakao APIì— ì˜í•´ ì•ˆì „í•˜ê²Œ í˜¸ì¶œë©ë‹ˆë‹¤.
    function initMapLogic() {
        // 1. URLì—ì„œ íŒŒë¼ë¯¸í„° ì½ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const lat = parseFloat(urlParams.get('lat'));
        const lng = parseFloat(urlParams.get('lng'));
        const km = parseFloat(urlParams.get('km'));

        // 2. ìœ íš¨ì„± ê²€ì‚¬ (í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ ì•ˆì „í•©ë‹ˆë‹¤)
        if (isNaN(lat) || isNaN(lng) || isNaN(km)) {
            document.getElementById('status_display').innerHTML = 'âŒ **ì˜¤ë¥˜:** URLì—ì„œ lat, lng, km íŒŒë¼ë¯¸í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.';
            document.getElementById('current_params').innerHTML = 'íŒŒë¼ë¯¸í„°: ìœ íš¨í•˜ì§€ ì•ŠìŒ';
            document.getElementById('map').innerHTML = 'ìœ íš¨í•œ ê²½ë¡œ íŒŒë¼ë¯¸í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            return; 
        }
        
        const params = { lat, lng, km };
        
        document.getElementById('current_params').innerHTML = `íŒŒë¼ë¯¸í„°: Lat: ${lat}, Lng: ${lng}, KM: ${km}`;
        
        // 3. ì§€ë„ ê°ì²´ ìƒì„± (kakao.mapsê°€ ë¡œë“œë˜ì—ˆìŒì„ ë³´ì¥)
        const centerCoords = new kakao.maps.LatLng(lat, lng); // <--- ì´ì œ ì´ ë¼ì¸ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        
        const mapContainer = document.getElementById('map');
        const mapOption = {
            center: centerCoords, 
            level: 4
        };

        const map = new kakao.maps.Map(mapContainer, mapOption);
        const statusDisplay = document.getElementById('status_display');
        
        // ë§ˆì»¤ ìƒì„± (ì¶œë°œì )
        new kakao.maps.Marker({
            map: map,
            position: centerCoords,
            title: 'ì¶œë°œ/ë„ì°© ì§€ì '
        });

        // 4. API í˜¸ì¶œ í•¨ìˆ˜
        function fetchRoute() {
            const query = new URLSearchParams(params).toString();
            const fullUrl = `${API_HOST}${API_PATH}?${query}`;
            
            statusDisplay.innerHTML = 'ìƒíƒœ: ê²½ë¡œ ë°ì´í„° ìš”ì²­ ì¤‘...';

            fetch(fullUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'ok') {
                        statusDisplay.innerHTML = `ìƒíƒœ: âœ… ê²½ë¡œ ë¡œë“œ ì„±ê³µ. (ê±°ë¦¬: ${data.summary.length_m}m, ì˜ˆìƒ ì‹œê°„: ${data.summary.estimated_time_min}ë¶„)`;
                        drawPolyline(data.polyline);
                        
                        const bounds = getBounds(data.polyline);
                        map.setBounds(bounds);
                        
                    } else {
                        statusDisplay.innerHTML = `ìƒíƒœ: âŒ ê²½ë¡œ ìƒì„± ì‹¤íŒ¨. (${data.message})`;
                        console.error('API Error:', data.message);
                    }
                })
                .catch(error => {
                    statusDisplay.innerHTML = `ìƒíƒœ: ğŸš¨ ê²½ë¡œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}. CORS/ë„¤íŠ¸ì›Œí¬ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
                    console.error('Fetch Error:', error);
                });
        }

        // 5. í´ë¦¬ë¼ì¸ ê·¸ë¦¬ê¸° ë° ì§€ë„ ê²½ê³„ ì„¤ì • í•¨ìˆ˜
        function drawPolyline(polylineData) {
            if (!polylineData || polylineData.length < 2) {
                console.warn('Polyline data is too short or missing.');
                return;
            }

            const path = polylineData.map(point => new kakao.maps.LatLng(point.lat, point.lng));

            const polyline = new kakao.maps.Polyline({
                path: path,
                strokeWeight: 5,           
                strokeColor: '#00AA00',    
                strokeOpacity: 0.8,        
                strokeStyle: 'solid'       
            });

            polyline.setMap(map);
        }
        
        function getBounds(polylineData) {
            const bounds = new kakao.maps.LatLngBounds();
            polylineData.forEach(point => {
                bounds.extend(new kakao.maps.LatLng(point.lat, point.lng));
            });
            return bounds;
        }

        // ì§€ë„ ë¡œë“œê°€ ì™„ë£Œë˜ë©´ ê²½ë¡œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        // kakao.maps.event.addListener ëŒ€ì‹  initMapLogic í•¨ìˆ˜ ì‹œì‘ ì‹œ ë°”ë¡œ fetchRoute ì‹¤í–‰
        fetchRoute();
    }
    
</script>
</body>
</html>
