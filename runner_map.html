<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>λ¬λ‹ κ²½λ΅ μ¶”μ² μ‹κ°ν™”</title>
    <style>
        #map {
            width: 100%;
            height: 90vh;
        }
        #info {
            padding: 10px;
            font-family: Arial, sans-serif;
            font-size: 14px;
        }
    </style>
    
    <script>
        // --- μ„¤μ • ---
        const API_HOST = "http://116.193.90.76:8000";
        const API_PATH = "/api/recommend-route";
        // -----------------

        // 1. URLμ—μ„ νλΌλ―Έν„°λ¥Ό λΉ λ¥΄κ² μ½κΈ°
        const urlParams = new URLSearchParams(window.location.search);
        const CURRENT_LAT = parseFloat(urlParams.get('lat'));
        const CURRENT_LNG = parseFloat(urlParams.get('lng'));
        const CURRENT_KM = parseFloat(urlParams.get('km'));

        const params = { 
            lat: CURRENT_LAT, 
            lng: CURRENT_LNG, 
            km: CURRENT_KM 
        };

        // 2. νλΌλ―Έν„° μ ν¨μ„± κ²€μ‚¬ (μ§€λ„ λ΅λ“ μ „ ν•„μ μ²΄ν¬)
        if (isNaN(CURRENT_LAT) || isNaN(CURRENT_LNG) || isNaN(CURRENT_KM)) {
            // μ§€λ„ λ΅λ“ μ „μ— DOM μ ‘κ·Όμ΄ κ°€λ¥ν•λ„λ΅ 'window.onload' μ΄λ²¤νΈμ—μ„ λ©”μ‹μ§€λ¥Ό μ„¤μ •ν•©λ‹λ‹¤.
            window.onload = function() {
                document.getElementById('status_display').innerHTML = 'β **μ¤λ¥:** URLμ—μ„ lat, lng, km νλΌλ―Έν„°λ¥Ό μ°Ύμ„ μ μ—†κ±°λ‚ ν•μ‹μ΄ μλ»λμ—μµλ‹λ‹¤.';
                document.getElementById('current_params').innerHTML = 'νλΌλ―Έν„°: μ ν¨ν•μ§€ μ•μ';
                document.getElementById('map').innerHTML = 'μ ν¨ν• κ²½λ΅ νλΌλ―Έν„°λ¥Ό μ…λ ¥ν•΄μ£Όμ„Έμ”.';
            };
            // νλΌλ―Έν„°κ°€ μ—†μΌλ©΄ μ§€λ„ SDK λ΅λ“ μμ²΄λ¥Ό κ±΄λ„λλ‹λ‹¤.
        } else {
            // [μμ • B: SDK λ΅λ“] νλΌλ―Έν„°κ°€ μ ν¨ν•  λ•λ§ SDKλ¥Ό λ™μ μΌλ΅ λ΅λ“ν•©λ‹λ‹¤.
            document.write('<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=f3beaea643bdd2136019b366df1190cf&libraries=services,clusterer,drawing&autoload=false" data-onload="initMapLogic" defer><\/script>');
        }
    </script>
</head>
<body>

<div id="info">
    <h2>πƒβ€β™€οΈ λ¬λ‹ κ²½λ΅ μ‹κ°ν™”</h2>
    <p>API Endpoint: <code>http://116.193.90.76:8000/api/recommend-route</code></p>
    <p id="current_params">νλΌλ―Έν„°: λ΅λ”© μ¤‘...</p>
    <p id="status_display">μƒνƒ: λ΅λ”© μ¤‘...</p>
</div>

<div id="map"></div>


<script>
    // [μμ • C: initMapLogic μ¬κµ¬μ„±] Kakao SDK λ΅λ“ μ™„λ£ ν›„ μ•μ „ν•κ² νΈμ¶λ©λ‹λ‹¤.
    function initMapLogic() {
        
        // DOM μ”μ†μ— νλΌλ―Έν„° μ •λ³΄ μ¶λ ¥
        document.getElementById('current_params').innerHTML = `νλΌλ―Έν„°: Lat: ${CURRENT_LAT}, Lng: ${CURRENT_LNG}, KM: ${CURRENT_KM}`;
        
        // 1. μ§€λ„ κ°μ²΄ μƒμ„± (μ „μ—­ λ³€μ CURRENT_LAT/LNG μ‚¬μ©)
        const centerCoords = new kakao.maps.LatLng(CURRENT_LAT, CURRENT_LNG);
        
        const mapContainer = document.getElementById('map');
        const mapOption = {
            center: centerCoords, 
            level: 4
        };

        const map = new kakao.maps.Map(mapContainer, mapOption);
        const statusDisplay = document.getElementById('status_display');
        
        // λ§μ»¤ μƒμ„± (μ¶λ°μ )
        new kakao.maps.Marker({
            map: map,
            position: centerCoords,
            title: 'μ¶λ°/λ„μ°© μ§€μ '
        });

        // 2. API νΈμ¶ ν•¨μ
        function fetchRoute() {
            const query = new URLSearchParams(params).toString();
            const fullUrl = `${API_HOST}${API_PATH}?${query}`;
            
            statusDisplay.innerHTML = 'μƒνƒ: κ²½λ΅ λ°μ΄ν„° μ”μ²­ μ¤‘...';

            fetch(fullUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'ok') {
                        statusDisplay.innerHTML = `μƒνƒ: β… κ²½λ΅ λ΅λ“ μ„±κ³µ. (κ±°λ¦¬: ${data.summary.length_m}m, μμƒ μ‹κ°„: ${data.summary.estimated_time_min}λ¶„)`;
                        drawPolyline(data.polyline);
                        
                        const bounds = getBounds(data.polyline);
                        map.setBounds(bounds);
                        
                    } else {
                        statusDisplay.innerHTML = `μƒνƒ: β κ²½λ΅ μƒμ„± μ‹¤ν¨. (${data.message})`;
                        console.error('API Error:', data.message);
                    }
                })
                .catch(error => {
                    statusDisplay.innerHTML = `μƒνƒ: π¨ κ²½λ΅ μ”μ²­ μ¤‘ μ¤λ¥ λ°μƒ: ${error.message}. CORS λ¬Έμ μΌ μ μμµλ‹λ‹¤.`;
                    console.error('Fetch Error:', error);
                });
        }

        // 3. ν΄λ¦¬λΌμΈ κ·Έλ¦¬κΈ° λ° μ§€λ„ κ²½κ³„ μ„¤μ • ν•¨μ
        function drawPolyline(polylineData) {
            if (!polylineData || polylineData.length < 2) {
                console.warn('Polyline data is too short or missing.');
                return;
            }

            const path = polylineData.map(point => new kakao.maps.LatLng(point.lat, point.lng));

            const polyline = new kakao.maps.Polyline({
                path: path,
                strokeWeight: 5,           
                strokeColor: '#00AA00',    
                strokeOpacity: 0.8,        
                strokeStyle: 'solid'       
            });

            polyline.setMap(map);
        }
        
        function getBounds(polylineData) {
            const bounds = new kakao.maps.LatLngBounds();
            polylineData.forEach(point => {
                bounds.extend(new kakao.maps.LatLng(point.lat, point.lng));
            });
            return bounds;
        }

        // μ§€λ„ λ΅λ“ μ™„λ£ ν›„ λ°”λ΅ κ²½λ΅λ¥Ό κ°€μ Έμµλ‹λ‹¤.
        fetchRoute();
    }
    
</script>
</body>
</html>
