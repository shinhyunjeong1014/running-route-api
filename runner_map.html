<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
    />
    <title>R2U Kakao Map - Debug Version</title>
    <style>
        html, body { margin:0; padding:0; height:100%; }
        #map { width:100%; height:90vh; }
        #info { padding:10px; font-family: Arial, sans-serif; font-size: 14px; }
    </style>
    
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f3beaea643bdd2136019b366df1190cf&libraries=services,clusterer,drawing"></script>
</head>
<body>

<div id="info">
    <h2>ëŸ¬ë‹ ê²½ë¡œ ì‹œê°í™” (console long ì—ì„œ json í™•ì¸ ê°€ëŠ¥)</h2>
    <p>API Endpoint: <code>http://116.193.90.76:8000/api/recommend-route</code></p>
    <p id="current_params">íŒŒë¼ë¯¸í„°: ë¡œë”© ì¤‘...</p>
    <p id="status_display">ìƒíƒœ: ì§€ë„ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ëŒ€ê¸° ì¤‘...</p>
</div>
<div id="map"></div>


<script>
    // --- ì„¤ì • ---
    const API_HOST = "http://116.193.90.76:8000";
    const API_PATH = "/api/recommend-route";
    // -----------------

    // ì „ì—­ ë³€ìˆ˜ (ì§€ë„/ê²½ë¡œ ê´€ë¦¬ìš©)
    var map;
    var routeLine = null;
    var startMarker = null;
    var endMarker = null;
    
    // 1. URL íŒŒë¼ë¯¸í„°ë¥¼ ì½ê³  ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥
    const urlParams = new URLSearchParams(window.location.search);
    const CURRENT_LAT = parseFloat(urlParams.get('lat'));
    const CURRENT_LNG = parseFloat(urlParams.get('lng'));
    const CURRENT_KM = parseFloat(urlParams.get('km'));
    const params = { lat: CURRENT_LAT, lng: CURRENT_LNG, km: CURRENT_KM };

    // DOM ìš”ì†Œ ìºì‹œ
    const statusDisplay = document.getElementById('status_display');
    const currentParamsDisplay = document.getElementById('current_params');


    // 2. [í•µì‹¬] ëª¨ë“  ì§€ë„ ë° ê²½ë¡œ ë¡œì§ì„ window.onload ì´ë²¤íŠ¸ì—ì„œ ì•ˆì „í•˜ê²Œ ì‹¤í–‰
    window.onload = function() {
        
        // íŒŒë¼ë¯¸í„° ìœ íš¨ì„± ê²€ì‚¬ (window.onload ì‹œì ì—ì„œ í™•ì¸)
        if (isNaN(CURRENT_LAT) || isNaN(CURRENT_LNG) || isNaN(CURRENT_KM)) {
            currentParamsDisplay.innerHTML = 'íŒŒë¼ë¯¸í„°: ìœ íš¨í•˜ì§€ ì•ŠìŒ';
            statusDisplay.innerHTML = 'âŒ **ì˜¤ë¥˜:** URL íŒŒë¼ë¯¸í„°(lat, lng, km)ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.';
            document.getElementById('map').innerHTML = 'ìœ íš¨í•œ ê²½ë¡œ íŒŒë¼ë¯¸í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            return;
        }

        // íŒŒë¼ë¯¸í„° ì •ë³´ ì¶œë ¥
        currentParamsDisplay.innerHTML = `íŒŒë¼ë¯¸í„°: Lat: ${CURRENT_LAT}, Lng: ${CURRENT_LNG}, KM: ${CURRENT_KM}`;
        
        // 3. ì§€ë„ ê°ì²´ ìƒì„±
        const container = document.getElementById('map');
        const centerCoords = new kakao.maps.LatLng(CURRENT_LAT, CURRENT_LNG);
        const options = {
            center: centerCoords, 
            level: 3
        };
        
        // kakao.maps ê°ì²´ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ ìµœì¢… í™•ì¸
        if (typeof kakao === 'undefined' || typeof kakao.maps === 'undefined') {
             statusDisplay.innerHTML = 'âŒ **ì˜¤ë¥˜:** ì¹´ì¹´ì˜¤ ì§€ë„ SDK ë¡œë“œ ì‹¤íŒ¨. API í‚¤ë‚˜ ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
             return;
        }

        map = new kakao.maps.Map(container, options);
        
        // ë§ˆì»¤ ìƒì„± (ì¶œë°œì )
        new kakao.maps.Marker({
            map: map,
            position: centerCoords,
            title: 'ì¶œë°œ/ë„ì°© ì§€ì '
        });

        // 4. API í˜¸ì¶œ ì‹œì‘
        fetchRoute();
    };


    // 5. API í˜¸ì¶œ ë° ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜
    function fetchRoute() {
        const query = new URLSearchParams(params).toString();
        const fullUrl = `${API_HOST}${API_PATH}?${query}`;
        
        statusDisplay.innerHTML = 'ìƒíƒœ: ê²½ë¡œ ë°ì´í„° ìš”ì²­ ì¤‘...';

        fetch(fullUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // [âœ… ì¶”ê°€ëœ ë¶€ë¶„] ì„±ê³µ/ì‹¤íŒ¨ì™€ ê´€ê³„ì—†ì´ ë°›ì€ ì›ë³¸ ë°ì´í„°ë¥¼ ì½˜ì†”ì— ì¶œë ¥í•©ë‹ˆë‹¤.
                console.log("--- API ì‘ë‹µ ë°ì´í„° (ë””ë²„ê¹…ìš©) ---");
                console.log(data);
                console.log("---------------------------------");
                
                if (data.status === 'ok') {
                    // API ì‘ë‹µ ì„±ê³µ ì‹œ, ê²½ë¡œ ì‹œê°í™” í•¨ìˆ˜ í˜¸ì¶œ
                    showRecommendedRoute(data); 
                    statusDisplay.innerHTML = `ìƒíƒœ: âœ… ê²½ë¡œ ë¡œë“œ ì„±ê³µ. (ê±°ë¦¬: ${data.summary.length_m}m, ì˜ˆìƒ ì‹œê°„: ${data.summary.estimated_time_min}ë¶„)`;
                } else {
                    statusDisplay.innerHTML = `ìƒíƒœ: âŒ ê²½ë¡œ ìƒì„± ì‹¤íŒ¨. (${data.message})`;
                    console.error('API Error:', data.message);
                }
            })
            .catch(error => {
                statusDisplay.innerHTML = `ìƒíƒœ: ğŸš¨ ê²½ë¡œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}.`;
                console.error('Fetch Error:', error);
            });
    }

    // 6. ê²½ë¡œ í‘œì‹œ ë¡œì§ (ì œê³µí•´ì£¼ì‹  ì½”ë“œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¬êµ¬ì„±)
    function showRecommendedRoute(routeData) {
        // 1) polyline ìœ íš¨ì„± ì²´í¬
        if (!routeData || !Array.isArray(routeData.polyline)) {
            console.warn("âš  polyline ë°°ì—´ì´ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.");
            return;
        }

        // 2) LatLng ë°°ì—´ë¡œ ë³€í™˜
        var linePath = routeData.polyline.map(function(p) {
            var lat = Number(p.lat);
            var lng = Number(p.lng);
            return new kakao.maps.LatLng(lat, lng); 
        });

        if (linePath.length === 0) {
            console.warn("âš  linePathê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
            return;
        }

        // 3) ê¸°ì¡´ ê²½ë¡œ/ë§ˆì»¤ ì œê±°
        if (routeLine) {
            routeLine.setMap(null);
        }
        if (startMarker) startMarker.setMap(null);
        if (endMarker) endMarker.setMap(null);

        // 4) ìƒˆ Polyline ìƒì„± (ì´ˆë¡ìƒ‰)
        routeLine = new kakao.maps.Polyline({
            map: map,
            path: linePath,
            strokeWeight: 5,
            strokeColor: '#00C853',
            strokeOpacity: 0.9,
            strokeStyle: 'solid'
        });

        // 5) ì‹œì‘/ë ë§ˆì»¤
        var startPos = linePath[0];
        var endPos = linePath[linePath.length - 1];

        startMarker = new kakao.maps.Marker({
            map: map,
            position: startPos
        });

        endMarker = new kakao.maps.Marker({
            map: map,
            position: endPos
        });

        // 6) í™”ë©´ì„ ì „ì²´ ê²½ë¡œì— ë§ì¶”ê¸°
        var bounds = new kakao.maps.LatLngBounds();
        linePath.forEach(function (pos) {
            bounds.extend(pos);
        });
        map.setBounds(bounds);

        console.log("âœ… í´ë¦¬ë¼ì¸/ë§ˆì»¤ í‘œì‹œ ì™„ë£Œ");
    }
</script>
</body>
</html>
