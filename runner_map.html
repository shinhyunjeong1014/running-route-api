<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ëŸ¬ë‹ ê²½ë¡œ ì¶”ì²œ ì‹œê°í™”</title>
    <style>
        #map {
            width: 100%;
            height: 90vh;
        }
        #info {
            padding: 10px;
            font-family: Arial, sans-serif;
            font-size: 14px;
        }
    </style>
    
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=f3beaea643bdd2136019b366df1190cf&libraries=services,clusterer,drawing" async></script>
</head>
<body>

<div id="info">
    <h2>ğŸƒâ€â™€ï¸ ëŸ¬ë‹ ê²½ë¡œ ì‹œê°í™”</h2>
    <p>API Endpoint: <code>http://116.193.90.76:8000/api/recommend-route</code></p>
    <p id="current_params">íŒŒë¼ë¯¸í„°: ë¡œë”© ì¤‘...</p>
    <p id="status_display">ìƒíƒœ: ë¡œë”© ì¤‘...</p>
</div>

<div id="map"></div>


<script>
    // [ìˆ˜ì • A ì ìš©] ì „ì²´ ë¡œì§ì„ í•¨ìˆ˜ë¡œ ê°ì‹¸ì„œ 'Illegal return statement' ì˜¤ë¥˜ë¥¼ í•´ê²°í•©ë‹ˆë‹¤.
    function initMapLogic() {
        // --- ì„¤ì • ---
        const API_HOST = "http://116.193.90.76:8000";
        const API_PATH = "/api/recommend-route";
        // -----------------

        // 1. URLì—ì„œ íŒŒë¼ë¯¸í„° ì½ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const lat = parseFloat(urlParams.get('lat'));
        const lng = parseFloat(urlParams.get('lng'));
        const km = parseFloat(urlParams.get('km'));

        // [ìˆ˜ì • A] ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨ ì‹œ í•¨ìˆ˜ë¥¼ ì¢…ë£Œ (return ë¬¸ì´ í•¨ìˆ˜ ë‚´ë¶€ì— ìœ„ì¹˜)
        if (isNaN(lat) || isNaN(lng) || isNaN(km)) {
            document.getElementById('status_display').innerHTML = 'âŒ **ì˜¤ë¥˜:** URLì—ì„œ lat, lng, km íŒŒë¼ë¯¸í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.';
            document.getElementById('current_params').innerHTML = 'íŒŒë¼ë¯¸í„°: ìœ íš¨í•˜ì§€ ì•ŠìŒ';
            document.getElementById('map').innerHTML = 'ìœ íš¨í•œ ê²½ë¡œ íŒŒë¼ë¯¸í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            return; 
        }
        
        const params = { lat, lng, km };
        
        document.getElementById('current_params').innerHTML = `íŒŒë¼ë¯¸í„°: Lat: ${lat}, Lng: ${lng}, KM: ${km}`;
        
        const centerCoords = new kakao.maps.LatLng(lat, lng);

        // 2. ì§€ë„ ì´ˆê¸° ì„¤ì •
        const mapContainer = document.getElementById('map');
        const mapOption = {
            center: centerCoords, 
            level: 4
        };

        // kakao ê°ì²´ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
        if (typeof kakao === 'undefined' || typeof kakao.maps === 'undefined') {
             document.getElementById('status_display').innerHTML = 'âŒ **ì˜¤ë¥˜:** ì¹´ì¹´ì˜¤ ì§€ë„ SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. API Keyë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
             return;
        }


        const map = new kakao.maps.Map(mapContainer, mapOption);
        const statusDisplay = document.getElementById('status_display');
        
        // ë§ˆì»¤ ìƒì„± (ì¶œë°œì )
        new kakao.maps.Marker({
            map: map,
            position: centerCoords,
            title: 'ì¶œë°œ/ë„ì°© ì§€ì '
        });

        // 3. API í˜¸ì¶œ í•¨ìˆ˜
        function fetchRoute() {
            const query = new URLSearchParams(params).toString();
            const fullUrl = `${API_HOST}${API_PATH}?${query}`;
            
            statusDisplay.innerHTML = 'ìƒíƒœ: ê²½ë¡œ ë°ì´í„° ìš”ì²­ ì¤‘...';

            fetch(fullUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'ok') {
                        statusDisplay.innerHTML = `ìƒíƒœ: âœ… ê²½ë¡œ ë¡œë“œ ì„±ê³µ. (ê±°ë¦¬: ${data.summary.length_m}m, ì˜ˆìƒ ì‹œê°„: ${data.summary.estimated_time_min}ë¶„)`;
                        drawPolyline(data.polyline);
                        
                        const bounds = getBounds(data.polyline);
                        map.setBounds(bounds);
                        
                    } else {
                        statusDisplay.innerHTML = `ìƒíƒœ: âŒ ê²½ë¡œ ìƒì„± ì‹¤íŒ¨. (${data.message})`;
                        console.error('API Error:', data.message);
                    }
                })
                .catch(error => {
                    statusDisplay.innerHTML = `ìƒíƒœ: ğŸš¨ ê²½ë¡œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}. CORS ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
                    console.error('Fetch Error:', error);
                });
        }

        // 4. í´ë¦¬ë¼ì¸ ê·¸ë¦¬ê¸° ë° ì§€ë„ ê²½ê³„ ì„¤ì • í•¨ìˆ˜
        function drawPolyline(polylineData) {
            if (!polylineData || polylineData.length < 2) {
                console.warn('Polyline data is too short or missing.');
                return;
            }

            const path = polylineData.map(point => new kakao.maps.LatLng(point.lat, point.lng));

            const polyline = new kakao.maps.Polyline({
                path: path,
                strokeWeight: 5,           
                strokeColor: '#00AA00',    
                strokeOpacity: 0.8,        
                strokeStyle: 'solid'       
            });

            polyline.setMap(map);
        }
        
        function getBounds(polylineData) {
            const bounds = new kakao.maps.LatLngBounds();
            polylineData.forEach(point => {
                bounds.extend(new kakao.maps.LatLng(point.lat, point.lng));
            });
            return bounds;
        }

        // ì§€ë„ ë¡œë“œê°€ ì™„ë£Œë˜ë©´ ê²½ë¡œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        kakao.maps.event.addListener(map, 'tilesloaded', fetchRoute);
    }
    
    // ì¹´ì¹´ì˜¤ ì§€ë„ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ í›„ initMapLogic ì‹¤í–‰
    if (document.readyState === 'loading') { // Loading hasn't finished yet
        window.addEventListener('load', initMapLogic);
    } else { // `DOMContentLoaded` has already fired
        initMapLogic();
    }
    
</script>
</body>
</html>
